<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bio.sys.dao.ReportDao">
	<select id="getLatestReport"
		resultType="com.bio.sys.domain.ReportDO">
		SELECT
		*
		FROM
		report
		WHERE
		author_id = #{authorid} and r_to_date
		<![CDATA[ < ]]>
		#{rfromdate}
		ORDER BY
		r_to_date DESC
		LIMIT 1
	</select>

	<select id="getReportCountByTitle" resultType="int">
		select count(*)
		from report where title = #{value}
	</select>


	<select id="getReports" resultType="com.bio.sys.domain.ReportDO">
		SELECT
		*
		FROM
		report
		WHERE
		r_from_date = #{fromdate}
		AND r_to_date = #{todate}
		AND status = #{status}
	</select>


	<select id="getReportsCount" resultType="com.bio.sys.domain.ReportCountDO">
		SELECT dept_id as deptId,
		count(dept_id) as countNumber
		FROM
		report 
		WHERE
		r_from_date = #{fromdate}
		AND r_to_date = #{todate}
		AND status = #{status} GROUP BY dept_id
	</select>

	<select id="getThisWeekReportByDept" resultType="com.bio.sys.domain.ReportDO">
		SELECT *
		FROM
		report
		WHERE
		dept_id = #{deptId}
		AND YEARWEEK(date_format(r_from_date,'%Y-%m-%d'),1) = YEARWEEK(now(),1)
		AND YEARWEEK(date_format(r_to_date,'%Y-%m-%d'),1) = YEARWEEK(now(),1)
	</select>

	<select id="getThisWeekReportByAuthorId" resultType="com.bio.sys.domain.ReportDO">
		SELECT *
		FROM
		report
		WHERE
		author_id = #{authorId}
		AND YEARWEEK(date_format(r_from_date,'%Y-%m-%d'),1) = YEARWEEK(now(),1)
		AND YEARWEEK(date_format(r_to_date,'%Y-%m-%d'),1) = YEARWEEK(now(),1)
	</select>

	<update id="updateBatch" parameterType="java.util.List" >
		<foreach collection="reportDOList" item="item" index="index" open="" close="" separator=";">
			update report
			<set >
				<if test="item.authorId != null" >
					author_id = #{item.authorId},
				</if>
				<if test="item.authorName != null" >
					author_name = #{item.authorName},
				</if>
				<if test="item.deptId != null" >
					dept_id = #{item.deptId},
				</if>
				<if test="item.deptName != null" >
					dept_name = #{item.deptName},
				</if>
				<if test="item.parentDeptId != null" >
					parent_dept_id = #{item.parentDeptId},
			</if>
				<if test="item.rFromDate != null" >
					r_from_date = #{item.rFromDate},
				</if>
				<if test="item.rToDate != null" >
					r_to_date = #{item.rToDate},
				</if>

				<if test="item.title != null" >
					title = #{item.title},
				</if>
				<if test="item.contentId != null" >
					content_id = #{item.contentId},
				</if>
				<if test="item.comment != null" >
					comment = #{item.comment},
				</if>
				<if test="item.score != null" >
					score = #{item.score},
				</if>

				<if test="item.suggest != null" >
					suggest = #{item.suggest},
				</if>
				<if test="item.rCreateDate != null" >
					r_create_date = #{item.rCreateDate},
				</if>
				<if test="item.rChgDate != null" >
					r_chg_date = #{item.rChgDate},
				</if>

				<if test="item.statusMod != null" >
					status_mod = #{item.statusMod},
				</if>
				<if test="item.statusMSub != null" >
					status_m_sub = #{item.statusMSub},
				</if>
				<if test="item.statusLSub != null" >
					status_l_sub = #{item.statusLSub},
				</if>
			</set>
			where id = #{item.id}
		</foreach>
	</update>


</mapper>